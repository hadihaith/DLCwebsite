{% extends 'frontend/layout.html' %}
{% load static %}

{% block title %}Course Refresh Progress{% endblock %}

{% block content %}
<div class="container" style="padding-top: 140px; padding-bottom: 60px; max-width: 800px;">
    <div class="card shadow-sm">
        <div class="card-body text-center p-5">
            <h2 class="mb-4">
                <i class="fas fa-sync-alt fa-spin text-primary"></i>
                Refreshing Courses
            </h2>
            
            <div class="mb-4">
                <div class="progress" style="height: 30px;">
                    <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" 
                         role="progressbar" 
                         style="width: 0%;" 
                         aria-valuenow="0" 
                         aria-valuemin="0" 
                         aria-valuemax="100">
                        <span id="progressText" class="fw-bold">0%</span>
                    </div>
                </div>
            </div>
            
            <div id="statusMessage" class="alert alert-info">
                <i class="fas fa-hourglass-half me-2"></i>
                <span id="messageText">Initializing...</span>
            </div>
            
            <div id="statsSection" class="d-none mt-4">
                <div class="row g-3 text-start">
                    <div class="col-6 col-md-3">
                        <div class="card bg-danger bg-opacity-10">
                            <div class="card-body p-3">
                                <div class="text-muted small">Deleted</div>
                                <div class="h4 mb-0" id="statDeleted">-</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-6 col-md-3">
                        <div class="card bg-success bg-opacity-10">
                            <div class="card-body p-3">
                                <div class="text-muted small">Fetched</div>
                                <div class="h4 mb-0" id="statFetched">-</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-6 col-md-3">
                        <div class="card bg-warning bg-opacity-10">
                            <div class="card-body p-3">
                                <div class="text-muted small">Cleaned</div>
                                <div class="h4 mb-0" id="statCleaned">-</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-6 col-md-3">
                        <div class="card bg-primary bg-opacity-10">
                            <div class="card-body p-3">
                                <div class="text-muted small">Final</div>
                                <div class="h4 mb-0" id="statFinal">-</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="completeSection" class="d-none mt-4">
                <div class="alert alert-success">
                    <i class="fas fa-check-circle me-2"></i>
                    Course refresh completed successfully!
                </div>
                <a href="{% url 'refresh_courses' %}" class="btn btn-primary">
                    <i class="fas fa-arrow-left me-2"></i>Back to Course Management
                </a>
            </div>
            
            <div id="errorSection" class="d-none mt-4">
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-circle me-2"></i>
                    <span id="errorText">An error occurred</span>
                </div>
                <a href="{% url 'refresh_courses' %}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left me-2"></i>Back to Course Management
                </a>
            </div>
        </div>
    </div>
</div>

<script>
    let pollInterval;
    let completionTimeout;
    
    function updateProgress() {
        fetch("{% url 'refresh_courses_status' %}")
            .then(response => response.json())
            .then(data => {
                const progress = data.progress || 0;
                const status = data.status || 'idle';
                const message = data.message || 'Processing...';
                const stats = data.stats || {};
                
                // Update progress bar
                const progressBar = document.getElementById('progressBar');
                const progressText = document.getElementById('progressText');
                progressBar.style.width = progress + '%';
                progressBar.setAttribute('aria-valuenow', progress);
                progressText.textContent = progress + '%';
                
                // Update status message
                const messageText = document.getElementById('messageText');
                const statusMessage = document.getElementById('statusMessage');
                messageText.textContent = message;
                
                // Update alert color based on status
                statusMessage.className = 'alert';
                if (status === 'completed') {
                    statusMessage.classList.add('alert-success');
                    progressBar.classList.remove('progress-bar-animated');
                    progressBar.classList.add('bg-success');
                } else if (status === 'error') {
                    statusMessage.classList.add('alert-danger');
                    progressBar.classList.remove('progress-bar-animated');
                    progressBar.classList.add('bg-danger');
                } else {
                    statusMessage.classList.add('alert-info');
                }
                
                // Show stats if available
                if (Object.keys(stats).length > 0) {
                    document.getElementById('statsSection').classList.remove('d-none');
                    document.getElementById('statDeleted').textContent = stats.deleted || '-';
                    document.getElementById('statFetched').textContent = stats.fetched || '-';
                    document.getElementById('statCleaned').textContent = stats.cleaned || '-';
                    document.getElementById('statFinal').textContent = stats.final || '-';
                }
                
                // Handle completion
                if (status === 'completed') {
                    clearInterval(pollInterval);
                    document.getElementById('completeSection').classList.remove('d-none');
                    
                    // Auto-redirect after 5 seconds
                    completionTimeout = setTimeout(() => {
                        window.location.href = "{% url 'refresh_courses' %}";
                    }, 5000);
                }
                
                // Handle error
                if (status === 'error') {
                    clearInterval(pollInterval);
                    document.getElementById('errorSection').classList.remove('d-none');
                    document.getElementById('errorText').textContent = message;
                }
            })
            .catch(error => {
                console.error('Error fetching progress:', error);
            });
    }
    
    // Start polling every 1 second
    pollInterval = setInterval(updateProgress, 1000);
    
    // Initial update
    updateProgress();
    
    // Cleanup on page unload
    window.addEventListener('beforeunload', () => {
        clearInterval(pollInterval);
        if (completionTimeout) {
            clearTimeout(completionTimeout);
        }
    });
</script>
{% endblock %}

{% extends 'frontend/layout.html' %}
{% load static %}

{% block title %}Apply for Exchange at KU{% endblock %}

{% block content %}
<section class="py-5" style="background:linear-gradient(135deg,#4a2e5f 0%,#704f9a 100%);">
    <div class="container py-5 text-white">
        <div class="row align-items-center">
            <div class="col-lg-7">
                <span class="badge bg-light text-primary mb-3" style="font-size:0.85rem;">Incoming Student Application</span>
                <h1 class="display-5 fw-bold mb-3">Start your Kuwait University exchange experience</h1>
                <p class="lead mb-0">Complete the form below exactly as it appears on your official documents. After submission, you'll upload your required documents (English proficiency certificate, official transcript, and passport copy) directly through an online form.</p>
            </div>
            <div class="col-lg-5 text-lg-end mt-4 mt-lg-0">
                <img src="{% static 'frontend/assets/img/exchange-application.png' %}" alt="Exchange application" class="img-fluid" onerror="this.style.display='none';">
            </div>
        </div>
    </div>
</section>

<section class="py-5 bg-light">
    <div class="container">
        {% if not applications_enabled %}
        <div class="alert alert-warning shadow-sm" role="alert">
            <h2 class="h5 fw-bold"><i class="fas fa-exclamation-triangle me-2"></i>Applications Currently Closed</h2>
            <p class="mb-0">{{ closed_message }}</p>
        </div>
        <div class="text-center mt-4">
            <a href="{% url 'exchange_program' %}" class="btn btn-primary">
                <i class="fas fa-arrow-left me-2"></i>Back to Exchange Program
            </a>
        </div>
        {% else %}
        {% if submitted %}
        <div class="alert alert-success shadow-sm mb-4" role="alert">
            <h2 class="h5 fw-bold"><i class="fas fa-check-circle me-2"></i>Application Submitted Successfully!</h2>
            <p class="mb-2">Thank you for submitting your exchange application to Kuwait University!</p>
            <p class="mb-0"><strong>Your Application ID: #{{ application_id }}</strong></p>
        </div>

        {% if document_form_url %}
        <!-- Document Upload Section -->
        <div class="card shadow-sm border-0 mb-4">
            <div class="card-header bg-primary text-white">
                <h3 class="h5 mb-0"><i class="fas fa-file-upload me-2"></i>Step 2: Upload Required Documents</h3>
            </div>
            <div class="card-body p-4">
                <div class="alert alert-info mb-4">
                    <h5 class="fw-bold mb-3"><i class="fas fa-info-circle me-2"></i>Important Instructions</h5>
                    <p class="mb-2">Please complete the form below to upload your required documents:</p>
                    <ul class="mb-2">
                        <li><strong>Proof of English Proficiency</strong> (TOEFL/IELTS certificate - PDF format)</li>
                        <li><strong>Official Transcript</strong> from your home institution (PDF format)</li>
                        <li><strong>Passport Copy</strong> (Photo page with personal details - PDF/PNG/JPG)</li>
                    </ul>
                    <p class="mb-0 text-danger"><strong>⚠️ Make sure to enter your Application ID: #{{ application_id }}</strong></p>
                </div>

                <!-- Embedded Microsoft Form -->
                <div class="ratio" style="aspect-ratio: 16 / 9; min-height: 600px;">
                    <iframe 
                        src="{{ document_form_url }}" 
                        frameborder="0" 
                        marginwidth="0" 
                        marginheight="0" 
                        style="border: none; max-width: 100%; max-height: 100vh;" 
                        allowfullscreen 
                        webkitallowfullscreen 
                        mozallowfullscreen 
                        msallowfullscreen>
                    </iframe>
                </div>

                <div class="alert alert-success mt-4">
                    <p class="mb-0"><i class="fas fa-check-circle me-2"></i>After uploading your documents, our team will review your complete application and contact you via email.</p>
                </div>
            </div>
        </div>
        {% else %}
        <!-- Fallback if no form URL is configured -->
        <div class="alert alert-warning shadow-sm" role="alert">
            <h5 class="fw-bold mb-2"><i class="fas fa-exclamation-triangle me-2"></i>Next Steps - Document Submission</h5>
            <p class="mb-2">Please prepare the following documents:</p>
            <ol class="mb-2">
                <li>Proof of English proficiency (TOEFL/IELTS - PDF format)</li>
                <li>Official transcript from your home institution (PDF format)</li>
                <li>Copy of your passport (photo page - PDF/PNG/JPG format)</li>
            </ol>
            <p class="mb-0">Our exchange office will contact you shortly with instructions on how to submit these documents. Please save your <strong>Application ID: #{{ application_id }}</strong> for reference.</p>
        </div>
        {% endif %}

        <div class="text-center mt-4">
            <a href="{% url 'exchange_program' %}" class="btn btn-outline-primary">
                <i class="fas fa-arrow-left me-2"></i>Back to Exchange Program
            </a>
        </div>
        {% endif %}

        {% if partner_count == 0 %}
        <div class="alert alert-warning" role="alert">
            We could not find any partner universities in our system. Please contact the Dean's List Council before submitting your application.
        </div>
        {% endif %}

        <div class="card shadow-sm border-0">
            <div class="card-body p-4 p-lg-5">
                <form method="post" novalidate>
                    {% csrf_token %}

                    {% if form.non_field_errors %}
                    <div class="alert alert-danger">
                        {% for error in form.non_field_errors %}
                            <div>{{ error }}</div>
                        {% endfor %}
                    </div>
                    {% endif %}

                    <div class="row g-4">
                        <div class="col-12">
                            <h2 class="h5 text-primary mb-3">Applicant information</h2>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label" for="id_first_name">{{ form.first_name.label }}</label>
                            {{ form.first_name }}
                            {% for error in form.first_name.errors %}<div class="text-danger small">{{ error }}</div>{% endfor %}
                        </div>
                        <div class="col-md-6">
                            <label class="form-label" for="id_last_name">{{ form.last_name.label }}</label>
                            {{ form.last_name }}
                            {% for error in form.last_name.errors %}<div class="text-danger small">{{ error }}</div>{% endfor %}
                        </div>
                        <div class="col-md-4">
                            <label class="form-label" for="id_date_of_birth">{{ form.date_of_birth.label }}</label>
                            {{ form.date_of_birth }}
                            {% for error in form.date_of_birth.errors %}<div class="text-danger small">{{ error }}</div>{% endfor %}
                        </div>
                        <div class="col-md-4">
                            <label class="form-label" for="id_gender">{{ form.gender.label }}</label>
                            {{ form.gender }}
                            {% for error in form.gender.errors %}<div class="text-danger small">{{ error }}</div>{% endfor %}
                        </div>
                        <div class="col-md-4">
                            <label class="form-label" for="id_program_level">{{ form.program_level.label }}</label>
                            {{ form.program_level }}
                            {% for error in form.program_level.errors %}<div class="text-danger small">{{ error }}</div>{% endfor %}
                        </div>
                        <div class="col-md-6">
                            <label class="form-label" for="id_email">{{ form.email.label }}</label>
                            {{ form.email }}
                            {% for error in form.email.errors %}<div class="text-danger small">{{ error }}</div>{% endfor %}
                        </div>
                    </div>

                    <hr class="my-5">

                    <div class="row g-4">
                        <div class="col-12">
                            <h2 class="h5 text-primary mb-3">Home institution details</h2>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label" for="id_home_institution">{{ form.home_institution.label }}</label>
                            {{ form.home_institution }}
                            <div class="form-text">Select the partner university that is nominating you.</div>
                            {% for error in form.home_institution.errors %}<div class="text-danger small">{{ error }}</div>{% endfor %}
                        </div>
                        <div class="col-md-6">
                            <label class="form-label" for="id_home_major">{{ form.home_major.label }}</label>
                            {{ form.home_major }}
                            {% for error in form.home_major.errors %}<div class="text-danger small">{{ error }}</div>{% endfor %}
                        </div>
                        <div class="col-md-6">
                            <label class="form-label" for="id_coordinator_name">{{ form.coordinator_name.label }}</label>
                            {{ form.coordinator_name }}
                            {% for error in form.coordinator_name.errors %}<div class="text-danger small">{{ error }}</div>{% endfor %}
                        </div>
                        <div class="col-md-6">
                            <label class="form-label" for="id_coordinator_email">{{ form.coordinator_email.label }}</label>
                            {{ form.coordinator_email }}
                            {% for error in form.coordinator_email.errors %}<div class="text-danger small">{{ error }}</div>{% endfor %}
                        </div>
                    </div>

                    <hr class="my-5">

                    <div class="row g-4">
                        <div class="col-12">
                            <h2 class="h5 text-primary mb-3">Exchange term & eligibility</h2>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label" for="id_exchange_semester">{{ form.exchange_semester.label }}</label>
                            {{ form.exchange_semester }}
                            {% for error in form.exchange_semester.errors %}<div class="text-danger small">{{ error }}</div>{% endfor %}
                        </div>
                        <div class="col-md-4">
                            <label class="form-label" for="id_exchange_academic_year">{{ form.exchange_academic_year.label }}</label>
                            {{ form.exchange_academic_year }}
                            {% for error in form.exchange_academic_year.errors %}<div class="text-danger small">{{ error }}</div>{% endfor %}
                        </div>
                        <div class="col-md-4">
                            <label class="form-label" for="id_completed_credits">{{ form.completed_credits.label }}</label>
                            {{ form.completed_credits }}
                            {% for error in form.completed_credits.errors %}<div class="text-danger small">{{ error }}</div>{% endfor %}
                        </div>
                    </div>

                    <hr class="my-5">

                    <div class="row g-4">
                        <div class="col-12">
                            <h2 class="h5 text-primary mb-3">Passport information</h2>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label" for="id_passport_number">{{ form.passport_number.label }}</label>
                            {{ form.passport_number }}
                            {% for error in form.passport_number.errors %}<div class="text-danger small">{{ error }}</div>{% endfor %}
                        </div>
                        <div class="col-md-6">
                            <label class="form-label" for="id_passport_expiry_date">{{ form.passport_expiry_date.label }}</label>
                            {{ form.passport_expiry_date }}
                            {% for error in form.passport_expiry_date.errors %}<div class="text-danger small">{{ error }}</div>{% endfor %}
                        </div>
                    </div>

                    <hr class="my-5">

                    <div class="row g-4">
                        <div class="col-12">
                            <h2 class="h5 text-primary mb-3">Next Step: Document Upload</h2>
                            <div class="alert alert-info border-0 shadow-sm">
                                <div class="d-flex align-items-start">
                                    <i class="fas fa-file-upload fa-2x text-primary me-3 mt-1"></i>
                                    <div>
                                        <h5 class="alert-heading mb-2">📄 Required Documents</h5>
                                        <p class="mb-2">After submitting this application, you'll be directed to upload the following documents directly through an online form:</p>
                                        <ul class="mb-2">
                                            <li><strong>Proof of English proficiency</strong> (TOEFL/IELTS certificate - PDF format)</li>
                                            <li><strong>Official transcript</strong> from your home institution (PDF format)</li>
                                            <li><strong>Copy of your passport</strong> (photo page with personal details - PDF/PNG/JPG)</li>
                                        </ul>
                                        <p class="mb-0 text-muted small">
                                            <i class="fas fa-info-circle me-1"></i><strong>Note:</strong> The upload form will appear immediately after you submit this application. 
                                            Make sure to have your documents ready to upload.
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <hr class="my-5">

                    <div class="row g-4">
                        <div class="col-12">
                            <h2 class="h5 text-primary mb-3">Declarations</h2>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check">
                                {{ form.accommodation_needed }}
                                <label class="form-check-label" for="id_accommodation_needed">{{ form.accommodation_needed.label }}</label>
                            </div>
                            {% for error in form.accommodation_needed.errors %}<div class="text-danger small">{{ error }}</div>{% endfor %}
                        </div>
                        <div class="col-md-6">
                            <div class="form-check">
                                {{ form.has_criminal_record }}
                                <label class="form-check-label" for="id_has_criminal_record">{{ form.has_criminal_record.label }}</label>
                            </div>
                            {% for error in form.has_criminal_record.errors %}<div class="text-danger small">{{ error }}</div>{% endfor %}
                        </div>
                    </div>

                    <div class="mt-5 d-flex justify-content-end">
                        <button type="submit" class="btn btn-primary btn-lg px-4">
                            Submit application
                        </button>
                    </div>
                </form>
            </div>
        </div>
        {% endif %}
    </div>
</section>
{% endblock %}

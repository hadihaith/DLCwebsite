{% extends 'frontend/portal.html' %}
{% load static %}

{% block portal_content %}
{% csrf_token %}
<link rel="stylesheet" href="{% static 'frontend/assets/css/application_management.css' %}">

<div class="application-management-container">
    <div class="management-header">
        <h2><i class="fas fa-parking"></i> Parking Spot Management</h2>
        <p>Review and manage parking spot applications</p>
        
        {% if latest_dean_list %}
        <div class="alert alert-info" style="max-width: 600px; margin: 0 auto 20px;">
            <small><i class="fas fa-info-circle"></i> Verification based on Dean's List: 
                <strong>{{ latest_dean_list.semester }} {{ latest_dean_list.year }}</strong>
            </small>
        </div>
        {% endif %}
        
        <div class="stats-summary">
            <div class="stat-card total">
                <div class="stat-number">{{ total_applications }}</div>
                <div class="stat-label">Total Applications</div>
            </div>
            <div class="stat-card eligible">
                <div class="stat-number">{{ eligible_applications }}</div>
                <div class="stat-label">Eligible</div>
            </div>
            <div class="stat-card rejected">
                <div class="stat-number">{{ ineligible_applications }}</div>
                <div class="stat-label">Ineligible</div>
            </div>
            {% if eligible_applications > 0 %}
            <div class="stat-card" style="border-color: #6f42c1;">
                <div class="stat-number" style="color: #6f42c1;">{{ avg_gpa|floatformat:2 }}</div>
                <div class="stat-label">Avg GPA (Eligible)</div>
            </div>
            {% endif %}
        </div>
        
        {% if can_delete_all and total_applications > 0 %}
        <div class="delete-all-container">
            <button id="deleteAllBtn" class="delete-all-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24">
                    <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                </svg>
                Delete All Parking Applications
            </button>
        </div>
        {% endif %}
    </div>

    {% if applications_with_status %}
    <div class="applications-table-container">
        <table class="applications-table">
            <thead>
                <tr>
                    <th>Priority</th>
                    <th>Status</th>
                    <th>Student ID</th>
                    <th>Name</th>
                    <th>Phone</th>
                    <th>GPA</th>
                    <th>Credits</th>
                    <th>Major</th>
                    <th>Kuwaiti License</th>
                    <th>Dean's List</th>
                    <th>Submitted</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for item in applications_with_status %}
                    {% if item.add_separator %}
                        <tr class="separator-row">
                            <td colspan="12" class="separator-cell">
                                <div class="applications-separator">
                                    <span>Ineligible Applications</span>
                                </div>
                            </td>
                        </tr>
                    {% endif %}
                    <tr class="{% if not item.eligible %}rejected{% else %}eligible{% endif %}">
                        <td class="priority-cell">
                            {% if item.eligible %}
                                <span class="priority-badge priority-{{ forloop.counter }}">
                                    #{{ forloop.counter }}
                                </span>
                            {% else %}
                                <span style="color: #999;">—</span>
                            {% endif %}
                        </td>
                        <td class="status-cell">
                            {% if not item.eligible %}
                                <div class="status-badge rejected">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24">
                                        <path d="M12 2C6.486 2 2 6.486 2 12s4.486 10 10 10 10-4.486 10-10S17.514 2 12 2zm0 18c-4.411 0-8-3.589-8-8s3.589-8 8-8 8 3.589 8 8-3.589 8-8 8z"/>
                                        <path d="M15.707 8.707L12 12.414 8.293 8.707 7.586 9.414 11.293 13.121 7.586 16.828 8.293 17.535 12 13.828 15.707 17.535 16.414 16.828 12.707 13.121 16.414 9.414z"/>
                                    </svg>
                                    INELIGIBLE
                                </div>
                                <div class="rejection-reasons">
                                    {% for reason in item.rejection_reasons %}
                                        <span class="rejection-reason">{{ reason }}</span>
                                    {% endfor %}
                                </div>
                            {% else %}
                                <div class="status-badge eligible">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24">
                                        <path d="M12 2C6.486 2 2 6.486 2 12s4.486 10 10 10 10-4.486 10-10S17.514 2 12 2zm0 18c-4.411 0-8-3.589-8-8s3.589-8 8-8 8 3.589 8 8-3.589 8-8 8z"/>
                                        <path d="M10.586 13.414l-2.293-2.293-1.414 1.414 3.707 3.707 6.414-6.414-1.414-1.414z"/>
                                    </svg>
                                    ELIGIBLE
                                </div>
                            {% endif %}
                        </td>
                        <td class="student-id-cell">
                            <strong>{{ item.application.student_id }}</strong>
                        </td>
                        <td class="name-cell">{{ item.application.student_name }}</td>
                        <td class="phone-cell">
                            <a href="tel:{{ item.application.phone }}" style="color: #007bff; text-decoration: none;">
                                <i class="fas fa-phone" style="margin-right: 4px;"></i>{{ item.application.phone }}
                            </a>
                        </td>
                        <td class="gpa-cell">
                            <strong style="{% if item.application.gpa >= 3.67 %}color: #28a745;{% else %}color: #dc3545;{% endif %}">
                                {{ item.application.gpa }}
                            </strong>
                        </td>
                        <td class="credits-cell">
                            <span style="color: #6c757d;">{{ item.application.completed_credits }}</span>
                        </td>
                        <td class="major-cell">
                            <span class="major-badge">{{ item.major_display }}</span>
                        </td>
                        <td class="license-cell" style="text-align: center;">
                            {% if item.application.has_kuwaiti_license %}
                                <span style="color: #28a745; font-size: 18px;">✓</span>
                            {% else %}
                                <span style="color: #dc3545; font-size: 18px;">✗</span>
                            {% endif %}
                        </td>
                        <td class="deans-list-cell" style="text-align: center;">
                            {% if "Dean's List" not in item.rejection_reasons|join:"" %}
                                <span style="color: #28a745; font-size: 18px;">✓</span>
                            {% else %}
                                <span style="color: #dc3545; font-size: 18px;">✗</span>
                            {% endif %}
                        </td>
                        <td class="submitted-cell">
                            <div class="timestamp">
                                {{ item.application.submitted_at|date:"M d, Y" }}<br>
                                <small>{{ item.application.submitted_at|time:"g:i A" }}</small>
                            </div>
                        </td>
                        <td class="actions-cell">
                            {% if can_delete %}
                            <button class="delete-btn" 
                                    data-id="{{ item.application.id }}"
                                    data-name="{{ item.application.student_name }}"
                                    title="Delete application">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24">
                                    <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                                </svg>
                            </button>
                            {% endif %}
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="no-data-container">
        <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M9 11H3v2h6v-2zm0 4H3v2h6v-2zm0-8H3v2h6V7zm10 4h-6v2h6v-2zm0 4h-6v2h6v-2zm0-8h-6v2h6V7z"/>
        </svg>
        <h3>No Parking Applications Yet</h3>
        <p>Applications will appear here once students start submitting them.</p>
    </div>
    {% endif %}
</div>

<!-- Delete Confirmation Modal -->
<div id="deleteModal" class="modal">
    <div class="modal-content">
        <h3>Confirm Deletion</h3>
        <p>Are you sure you want to delete the parking application for <strong id="deleteName"></strong>?</p>
        <div class="modal-actions">
            <button id="confirmDelete" class="btn-danger">Delete</button>
            <button id="cancelDelete" class="btn-secondary">Cancel</button>
        </div>
    </div>
</div>

<!-- Delete All Confirmation Modal -->
<div id="deleteAllModal" class="modal">
    <div class="modal-content">
        <h3>⚠️ Confirm Mass Deletion</h3>
        <p>Are you sure you want to delete <strong>ALL {{ total_applications }} parking applications</strong>?</p>
        <p style="color: #dc3545; font-weight: bold;">This action cannot be undone!</p>
        <div class="modal-actions">
            <button id="confirmDeleteAll" class="btn-danger">Delete All</button>
            <button id="cancelDeleteAll" class="btn-secondary">Cancel</button>
        </div>
    </div>
</div>

<style>
/* Priority Badge Styling */
.priority-badge {
    display: inline-block;
    padding: 4px 10px;
    border-radius: 12px;
    font-weight: bold;
    font-size: 12px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

/* Gold, Silver, Bronze for top 3 */
.priority-1 {
    background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%) !important;
    color: #000 !important;
    box-shadow: 0 2px 8px rgba(255, 215, 0, 0.3);
}

.priority-2 {
    background: linear-gradient(135deg, #C0C0C0 0%, #808080 100%) !important;
    color: #000 !important;
    box-shadow: 0 2px 8px rgba(192, 192, 192, 0.3);
}

.priority-3 {
    background: linear-gradient(135deg, #CD7F32 0%, #8B4513 100%) !important;
    color: white !important;
    box-shadow: 0 2px 8px rgba(205, 127, 50, 0.3);
}

.priority-cell {
    text-align: center;
    font-weight: bold;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const deleteModal = document.getElementById('deleteModal');
    const deleteAllModal = document.getElementById('deleteAllModal');
    const deleteButtons = document.querySelectorAll('.delete-btn');
    const deleteAllBtn = document.getElementById('deleteAllBtn');
    const confirmDelete = document.getElementById('confirmDelete');
    const cancelDelete = document.getElementById('cancelDelete');
    const confirmDeleteAll = document.getElementById('confirmDeleteAll');
    const cancelDeleteAll = document.getElementById('cancelDeleteAll');
    
    let currentApplicationId = null;
    
    // Individual delete
    deleteButtons.forEach(button => {
        button.addEventListener('click', function() {
            currentApplicationId = this.getAttribute('data-id');
            const name = this.getAttribute('data-name');
            document.getElementById('deleteName').textContent = name;
            deleteModal.style.display = 'flex';
        });
    });
    
    confirmDelete.addEventListener('click', function() {
        if (currentApplicationId) {
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            
            fetch(`/portal/parking/delete/${currentApplicationId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                alert('An error occurred while deleting the application.');
                console.error('Error:', error);
            });
            
            deleteModal.style.display = 'none';
        }
    });
    
    cancelDelete.addEventListener('click', function() {
        deleteModal.style.display = 'none';
        currentApplicationId = null;
    });
    
    // Delete all
    if (deleteAllBtn) {
        deleteAllBtn.addEventListener('click', function() {
            deleteAllModal.style.display = 'flex';
        });
    }
    
    if (confirmDeleteAll) {
        confirmDeleteAll.addEventListener('click', function() {
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            
            fetch('/portal/parking/delete-all/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                alert('An error occurred while deleting applications.');
                console.error('Error:', error);
            });
            
            deleteAllModal.style.display = 'none';
        });
    }
    
    if (cancelDeleteAll) {
        cancelDeleteAll.addEventListener('click', function() {
            deleteAllModal.style.display = 'none';
        });
    }
    
    // Close modals on outside click
    window.addEventListener('click', function(event) {
        if (event.target === deleteModal) {
            deleteModal.style.display = 'none';
            currentApplicationId = null;
        }
        if (event.target === deleteAllModal) {
            deleteAllModal.style.display = 'none';
        }
    });
});
</script>

{% endblock %}

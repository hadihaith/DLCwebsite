{% extends "frontend/layout.html" %}
{% load static %}

{% block content %}
<style>
    .settings-container {
        margin-top: 120px;
        margin-bottom: 50px;
    }
    
    .settings-card {
        background-color: #fff;
        border-radius: 10px;
        padding: 30px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        margin-bottom: 30px;
    }
    
    .status-badge {
        padding: 8px 16px;
        border-radius: 20px;
        font-weight: bold;
        font-size: 0.9em;
    }
    
    .status-enabled {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }
    
    .status-disabled {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }
    
    .btn-primary {
        background-color: #4A2E5F;
        border-color: #4A2E5F;
    }
    
    .btn-primary:hover {
        background-color: #3a2349;
        border-color: #3a2349;
    }
    
    .btn-warning {
        background-color: #f0ad4e;
        border-color: #eea236;
    }
    
    .btn-success {
        background-color: #5cb85c;
        border-color: #4cae4c;
    }
    
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .stat-card {
        background-color: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        text-align: center;
        border-left: 4px solid #4A2E5F;
    }
    
    .stat-number {
        font-size: 2em;
        font-weight: bold;
        color: #4A2E5F;
        display: block;
    }
    
    .stat-label {
        color: #6c757d;
        margin-top: 5px;
    }
    
    .toggle-section {
        border: 2px solid #e9ecef;
        border-radius: 8px;
        padding: 25px;
        margin-bottom: 30px;
    }
    
    .message-section {
        background-color: #f8f9fa;
        border-radius: 8px;
        padding: 25px;
        border-left: 4px solid #4A2E5F;
    }
    
    .page-title {
        color: #4A2E5F;
        margin-bottom: 30px;
    }
    
    .back-link {
        color: #4A2E5F;
        text-decoration: none;
        margin-bottom: 20px;
        display: inline-block;
    }
    
    .back-link:hover {
        color: #3a2349;
        text-decoration: underline;
    }
    
    .confirmation-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        display: none;
        align-items: center;
        justify-content: center;
    }
    
    .confirmation-dialog {
        background-color: white;
        border-radius: 10px;
        padding: 30px;
        max-width: 500px;
        width: 90%;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        text-align: center;
    }
    
    .confirmation-icon {
        font-size: 3em;
        color: #f0ad4e;
        margin-bottom: 20px;
    }
    
    .confirmation-title {
        color: #333;
        margin-bottom: 15px;
        font-size: 1.3em;
    }
    
    .confirmation-text {
        color: #666;
        margin-bottom: 25px;
        line-height: 1.5;
    }
    
    .confirmation-buttons {
        display: flex;
        gap: 15px;
        justify-content: center;
    }
    
    .btn-confirm {
        background-color: #d9534f;
        border-color: #d43f3a;
        color: white;
        padding: 10px 25px;
    }
    
    .btn-confirm:hover {
        background-color: #c9302c;
        border-color: #ac2925;
        color: white;
    }
    
    .btn-cancel {
        background-color: #6c757d;
        border-color: #6c757d;
        color: white;
        padding: 10px 25px;
    }
    
    .btn-cancel:hover {
        background-color: #5a6268;
        border-color: #545b62;
        color: white;
    }
</style>

<div class="container settings-container">
    <a href="{% url 'portal' %}" class="back-link">
        <i class="fas fa-arrow-left"></i> Back to Portal
    </a>
    
    <h1 class="page-title text-center">Thread Settings Management</h1>
    <p class="text-center text-muted mb-4">Manage thread creation and closure settings for the contact system</p>
    
    <!-- Messages -->
    {% if message %}
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        <i class="fas fa-check-circle"></i> {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    {% endif %}
    
    {% if error_message %}
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        <i class="fas fa-exclamation-circle"></i> {{ error_message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    {% endif %}
    
    <!-- Statistics -->
    <div class="settings-card">
        <h3 class="mb-4">Thread Statistics</h3>
        <div class="stats-grid">
            <div class="stat-card">
                <span class="stat-number">{{ total_threads }}</span>
                <div class="stat-label">Total Threads</div>
            </div>
            <div class="stat-card">
                <span class="stat-number">{{ total_replies }}</span>
                <div class="stat-label">Total Replies</div>
            </div>
            <div class="stat-card">
                <span class="stat-number">{{ recent_threads }}</span>
                <div class="stat-label">This Week</div>
            </div>
        </div>
    </div>
    
    <!-- Current Status -->
    <div class="settings-card">
        <h3 class="mb-4">Current Status</h3>
        <div class="d-flex align-items-center justify-content-between">
            <div>
                <strong>Thread Creation:</strong>
                {% if settings.allow_new_threads %}
                    <span class="status-badge status-enabled">
                        <i class="fas fa-check-circle"></i> Enabled
                    </span>
                {% else %}
                    <span class="status-badge status-disabled">
                        <i class="fas fa-times-circle"></i> Disabled
                    </span>
                {% endif %}
            </div>
            <div class="text-muted">
                {% if settings.updated_by %}
                    Last updated by {{ settings.updated_by.get_full_name }} 
                    on {{ settings.last_updated|date:"M d, Y \a\t g:i A" }}
                {% else %}
                    No recent updates
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Toggle Thread Creation -->
    <div class="settings-card">
        <div class="toggle-section">
            <h4 class="mb-3">
                <i class="fas fa-toggle-on"></i> Toggle Thread Creation
            </h4>
            <p class="text-muted mb-4">
                Enable or disable the ability for users to create new threads on the contact page.
                Existing threads and replies will remain accessible. Any logged-in member can modify these settings.
            </p>
            
            <form method="post" style="display: inline;" id="toggleForm">
                {% csrf_token %}
                <input type="hidden" name="action" value="toggle_threads">
                {% if settings.allow_new_threads %}
                    <button type="button" class="btn btn-warning" id="disableButton">
                        <i class="fas fa-ban"></i> Disable Thread Creation
                    </button>
                {% else %}
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-play"></i> Enable Thread Creation
                    </button>
                {% endif %}
            </form>
        </div>
    </div>
    
    <!-- Closure Message -->
    <div class="settings-card">
        <div class="message-section">
            <h4 class="mb-3">
                <i class="fas fa-comment-slash"></i> Closure Message
            </h4>
            <p class="text-muted mb-3">
                This message will be displayed to users when thread creation is disabled.
            </p>
            
            <form method="post">
                {% csrf_token %}
                <input type="hidden" name="action" value="update_message">
                <div class="mb-3">
                    <label for="closure_message" class="form-label">Message</label>
                    <textarea class="form-control" id="closure_message" name="closure_message" 
                              rows="4" placeholder="Enter the message to display when threading is disabled..." 
                              data-text-content>{{ settings.closure_message }}</textarea>
                </div>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save"></i> Update Message
                </button>
            </form>
            
            <div class="mt-3">
                <strong>Current Message:</strong>
                <div class="border rounded p-3 mt-2 bg-light" data-text-content>
                    {{ settings.closure_message }}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Confirmation Dialog -->
<div class="confirmation-overlay" id="confirmationOverlay">
    <div class="confirmation-dialog">
        <div class="confirmation-icon">
            <i class="fas fa-exclamation-triangle"></i>
        </div>
        <h4 class="confirmation-title">Disable Thread Creation?</h4>
        <p class="confirmation-text">
            Are you sure you want to disable thread creation? Users will no longer be able to create new threads on the contact page, but existing threads and replies will remain accessible.
        </p>
        <div class="confirmation-buttons">
            <button type="button" class="btn btn-cancel" id="cancelButton">
                <i class="fas fa-times"></i> Cancel
            </button>
            <button type="button" class="btn btn-confirm" id="confirmButton">
                <i class="fas fa-ban"></i> Yes, Disable
            </button>
        </div>
    </div>
</div>

<!-- Include Font Awesome for icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Function to detect if text contains Arabic characters
    function containsArabic(text) {
        const arabicPattern = /[\u0600-\u06FF\u0750-\u077F\u08A0-\u08FF\uFB50-\uFDFF\uFE70-\uFEFF]/;
        return arabicPattern.test(text);
    }
    
    // Function to apply text alignment based on language detection
    function applyTextAlignment() {
        const textElements = document.querySelectorAll('[data-text-content]');
        
        textElements.forEach(function(element) {
            const text = element.textContent || element.innerText || element.value;
            
            if (containsArabic(text)) {
                element.style.textAlign = 'right';
                element.style.direction = 'rtl';
            } else {
                element.style.textAlign = 'left';
                element.style.direction = 'ltr';
            }
        });
    }
    
    // Apply alignment on page load
    applyTextAlignment();
    
    // Add real-time text alignment for textarea
    const messageTextarea = document.getElementById('closure_message');
    if (messageTextarea) {
        messageTextarea.addEventListener('input', function() {
            const text = this.value;
            if (containsArabic(text)) {
                this.style.textAlign = 'right';
                this.style.direction = 'rtl';
            } else {
                this.style.textAlign = 'left';
                this.style.direction = 'ltr';
            }
        });
    }
    
    // Handle disable button confirmation
    const disableButton = document.getElementById('disableButton');
    const confirmationOverlay = document.getElementById('confirmationOverlay');
    const cancelButton = document.getElementById('cancelButton');
    const confirmButton = document.getElementById('confirmButton');
    const toggleForm = document.getElementById('toggleForm');
    
    if (disableButton) {
        disableButton.addEventListener('click', function() {
            confirmationOverlay.style.display = 'flex';
        });
    }
    
    if (cancelButton) {
        cancelButton.addEventListener('click', function() {
            confirmationOverlay.style.display = 'none';
        });
    }
    
    if (confirmButton) {
        confirmButton.addEventListener('click', function() {
            toggleForm.submit();
        });
    }
    
    // Close dialog when clicking outside
    if (confirmationOverlay) {
        confirmationOverlay.addEventListener('click', function(e) {
            if (e.target === confirmationOverlay) {
                confirmationOverlay.style.display = 'none';
            }
        });
    }
    
    // Close dialog with Escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && confirmationOverlay.style.display === 'flex') {
            confirmationOverlay.style.display = 'none';
        }
    });
});
</script>
{% endblock %}

{% extends 'frontend/portal.html' %}
{% load static %}

{% block portal_content %}

<div class="restore-container">
    <div class="warning-banner" style="background: linear-gradient(135deg, #28a745, #20c997); border-color: #218838;">
        <div class="warning-icon">‚ú®</div>
        <div class="warning-content">
            <h2>Database Import - Smart Merge</h2>
            <p><strong>SAFE MODE:</strong> This will ADD missing data from your uploaded file without deleting anything!</p>
        </div>
    </div>

    <div class="info-box">
        <h3>‚ö° How It Works</h3>
        <ul>
            <li><strong>Current Database:</strong> <span class="db-badge">{{ current_db }}</span></li>
            <li><strong>Smart Merging:</strong> Only adds records that don't already exist in your database</li>
            <li><strong>Preserves Existing Data:</strong> Your current data is never touched or deleted</li>
            <li><strong>No Backups Needed:</strong> Since existing data is preserved, this operation is completely safe</li>
            <li><strong>Duplicate Detection:</strong> Automatically skips records that already exist (by student ID, event title+date, etc.)</li>
            <li><strong>Detailed Report:</strong> Shows exactly what was added vs. skipped</li>
            <li><strong>Multiple Uploads:</strong> You can upload multiple files to merge data from different sources</li>
        </ul>
    </div>

    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }}">
                {{ message }}
            </div>
        {% endfor %}
    {% endif %}

    <div class="form-container">
        <h3>Upload SQLite Database File</h3>
        <form method="post" enctype="multipart/form-data" id="restoreForm">
            {% csrf_token %}
            
            <div class="form-group">
                <label for="database_file">Select SQLite Database File</label>
                <input 
                    type="file" 
                    id="database_file" 
                    name="database_file" 
                    accept=".sqlite3,.db,.sqlite"
                    required
                >
                <small class="form-help">
                    Supported formats: .sqlite3, .db, .sqlite<br>
                    (e.g., your local development database)
                </small>
            </div>

            <div class="confirmation-box" style="background: linear-gradient(135deg, #d4edda, #c3e6cb); border-color: #28a745;">
                <input type="checkbox" id="confirmRestore" required>
                <label for="confirmRestore" style="color: #155724;">
                    I understand that this will merge new data from the uploaded file into my current database
                </label>
            </div>

            <div class="form-actions">
                <button type="submit" class="btn-danger" id="restoreBtn" disabled style="background: linear-gradient(135deg, #28a745, #20c997);">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
                    </svg>
                    Import / Merge Data
                </button>
                
                <a href="{% url 'portal' %}" class="btn-cancel">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M19 11H7.83l4.88-4.88c.39-.39.39-1.03 0-1.42-.39-.39-1.02-.39-1.41 0l-6.59 6.59c-.39.39-.39 1.02 0 1.41l6.59 6.59c.39.39 1.02.39 1.41 0 .39-.39.39-1.02 0-1.41L7.83 13H19c.55 0 1-.45 1-1s-.45-1-1-1z"/>
                    </svg>
                    Cancel
                </a>
            </div>
        </form>
    </div>

    <div class="help-box">
        <h3>üìã How to Use</h3>
        <ol>
            <li><strong>Select File:</strong> Choose your SQLite database file (e.g., db.sqlite3 from local development)</li>
            <li><strong>Smart Merge:</strong> System automatically detects duplicates and only adds new records</li>
            <li><strong>Confirm:</strong> Check the confirmation box</li>
            <li><strong>Import:</strong> Click "Import / Merge Data"</li>
            <li><strong>Review Results:</strong> Check the detailed statistics showing what was added vs. skipped</li>
        </ol>
        <div style="margin-top: 15px; padding: 10px; background: #d4edda; border-left: 4px solid #28a745; border-radius: 4px;">
            <strong>‚ú® What Gets Imported:</strong><br>
            ‚Ä¢ Users (checked by student_id)<br>
            ‚Ä¢ Events (checked by title + date)<br>
            ‚Ä¢ Applications (checked by student_id + year)<br>
            ‚Ä¢ Attendance, Threads, Dean Lists, Courses, and more!<br>
            <br>
            <strong>üõ°Ô∏è Safety:</strong> Existing data is NEVER deleted or modified!
        </div>
    </div>
</div>

<style>
.restore-container {
    max-width: 900px;
    margin: 0 auto;
    padding: 20px;
}

.warning-banner {
    background: linear-gradient(135deg, #c0392b, #e74c3c);
    border: 3px solid #a93226;
    border-radius: 12px;
    padding: 25px;
    margin-bottom: 30px;
    display: flex;
    align-items: center;
    gap: 20px;
    box-shadow: 0 6px 20px rgba(192, 57, 43, 0.3);
}

.warning-icon {
    font-size: 48px;
    flex-shrink: 0;
}

.warning-content h2 {
    color: white;
    margin: 0 0 10px 0;
    font-weight: 700;
}

.warning-content p {
    color: #fef5e7;
    margin: 0;
    font-size: 16px;
}

.info-box, .help-box {
    background: white;
    border: 2px solid #3498db;
    border-radius: 12px;
    padding: 25px;
    margin-bottom: 30px;
    box-shadow: 0 4px 15px rgba(52, 152, 219, 0.1);
}

.info-box h3, .help-box h3 {
    color: #2c3e50;
    margin: 0 0 15px 0;
    font-weight: 600;
}

.info-box ul {
    margin: 0;
    padding-left: 25px;
}

.info-box li {
    margin-bottom: 10px;
    color: #34495e;
    line-height: 1.6;
}

.info-box code {
    background-color: #ecf0f1;
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 13px;
    color: #e74c3c;
}

.db-badge {
    background: linear-gradient(135deg, #3498db, #2980b9);
    color: white;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 13px;
    font-weight: 600;
    display: inline-block;
    box-shadow: 0 2px 5px rgba(52, 152, 219, 0.3);
}

.help-box ol {
    margin: 0;
    padding-left: 25px;
}

.help-box li {
    margin-bottom: 10px;
    color: #34495e;
    line-height: 1.6;
}

.alert {
    padding: 15px 20px;
    border-radius: 8px;
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 10px;
}

.alert-success {
    background: linear-gradient(135deg, #d4edda, #c3e6cb);
    border: 2px solid #28a745;
    color: #155724;
}

.alert-error {
    background: linear-gradient(135deg, #f8d7da, #f5c6cb);
    border: 2px solid #dc3545;
    color: #721c24;
}

.alert-info {
    background: linear-gradient(135deg, #d1ecf1, #bee5eb);
    border: 2px solid #17a2b8;
    color: #0c5460;
}

.form-container {
    background: white;
    border-radius: 12px;
    padding: 30px;
    box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
    border: 1px solid #e9ecef;
    margin-bottom: 30px;
}

.form-container h3 {
    color: #2c3e50;
    margin: 0 0 20px 0;
    font-weight: 600;
}

.form-group {
    margin-bottom: 25px;
}

.form-group label {
    display: block;
    font-weight: 600;
    color: #2c3e50;
    margin-bottom: 8px;
    font-size: 14px;
}

.form-group input[type="file"] {
    width: 100%;
    padding: 12px;
    border: 2px solid #e9ecef;
    border-radius: 6px;
    font-size: 14px;
    transition: all 0.2s;
    background-color: white;
}

.form-group input[type="file"]:focus {
    outline: none;
    border-color: #3498db;
    box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
}

.form-help {
    display: block;
    margin-top: 5px;
    font-size: 12px;
    color: #6c757d;
    font-style: italic;
}

.confirmation-box {
    background: linear-gradient(135deg, #fff3cd, #ffeeba);
    border: 2px solid #ffc107;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 25px;
    display: flex;
    align-items: center;
    gap: 10px;
}

.confirmation-box input[type="checkbox"] {
    width: 20px;
    height: 20px;
    cursor: pointer;
}

.confirmation-box label {
    margin: 0;
    color: #856404;
    font-weight: 500;
    cursor: pointer;
}

.form-actions {
    display: flex;
    gap: 15px;
    justify-content: flex-end;
    padding-top: 20px;
    border-top: 1px solid #e9ecef;
}

.btn-danger, .btn-cancel {
    padding: 12px 24px;
    border-radius: 6px;
    border: none;
    font-weight: 500;
    text-decoration: none;
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
    transition: all 0.2s;
    font-size: 14px;
}

.btn-danger {
    background: linear-gradient(135deg, #c0392b, #e74c3c);
    color: white;
}

.btn-danger:hover:not(:disabled) {
    background: linear-gradient(135deg, #218838, #1a9e7a);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
}

.btn-danger:disabled {
    background: linear-gradient(135deg, #bdc3c7, #d5dbdb);
    color: #7f8c8d;
    cursor: not-allowed;
}

.btn-cancel {
    background: linear-gradient(135deg, #95a5a6, #bdc3c7);
    color: white;
}

.btn-cancel:hover {
    background: linear-gradient(135deg, #7f8c8d, #95a5a6);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(149, 165, 166, 0.3);
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const checkbox = document.getElementById('confirmRestore');
    const restoreBtn = document.getElementById('restoreBtn');
    const form = document.getElementById('restoreForm');
    
    checkbox.addEventListener('change', function() {
        restoreBtn.disabled = !this.checked;
    });
    
    form.addEventListener('submit', function(e) {
        if (!confirm('Ready to import data? This will add new records from the uploaded file to your current database.')) {
            e.preventDefault();
        }
    });
});
</script>

{% endblock %}
